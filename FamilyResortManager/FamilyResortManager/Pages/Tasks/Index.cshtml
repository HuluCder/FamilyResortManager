@page
@using Microsoft.AspNetCore.Identity
@using FamilyResortManager.Data.DataBase.Models
@model FamilyResortManager.Pages.Tasks.IndexModel
@{
    ViewData["Title"] = "–ó–∞–¥–∞—á–∏";
    var isAdmin = User.IsInRole("Administrator");
}

<div class="container mx-auto py-6">
    <h1 class="text-2xl font-bold mb-4">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h1>

    @if (isAdmin)
    {
        <a class="btn btn-primary mb-3" asp-page="Create">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</a>
    }

    <!-- üîΩ –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <form method="get" id="filterForm" class="mb-4 d-flex flex-wrap gap-3 align-items-end">
        <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select name="StatusFilter" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="">–í—Å–µ</option>
                @foreach (var status in Model.AvailableStatuses)
                {
                    <option value="@status" selected="@(status == Model.StatusFilter)">
                        @status
                    </option>
                }
            </select>
        </div>
        <div>
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select name="CategoryFilter" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="">–í—Å–µ</option>
                @foreach (var category in Model.AvailableCategories)
                {
                    <option value="@category" selected="@(category == Model.CategoryFilter)">
                        @category
                    </option>
                }
            </select>
        </div>
        <div>
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
            <select name="SortBy" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="CreatedAt" selected="@(Model.SortBy == "CreatedAt")">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                <option value="Priority" selected="@(Model.SortBy == "Priority")">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            </select>
        </div>
        <div>
            <label>–ü–æ—Ä—è–¥–æ–∫</label>
            <select name="SortOrder" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="asc" selected="@(Model.SortOrder == "asc")">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                <option value="desc" selected="@(Model.SortOrder == "desc")">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            </select>
        </div>
        <div>
            <label>–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É</label>
            <input type="text" name="TitleSearch" class="form-control" value="@Model.TitleSearch"
                   oninput="clearTimeout(this._timeout); this._timeout = setTimeout(() => document.getElementById('filterForm').submit(), 500)" />
        </div>
        <a href="./Index" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </form>
    <!-- üîº –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->

    <table class="table">
        <thead>
            <tr>
                <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                @if (!isAdmin)
                {
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th>–ò–∑–º–µ–Ω–∏—Ç—å</th>
                }
                @if (isAdmin)
                {
                    <th>–õ–æ–≥–∏</th>
                }
            </tr>
        </thead>
        <tbody>
        @foreach (var task in Model.Tasks)
        {
            <tr>
                <td>@task.Title</td>
                <td>@task.Category</td>
                <td>@task.Priority</td>
                <td>@(task.AssignedToUser?.FullName ?? task.AssignedToUser?.Email ?? "(–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω)")</td>
                <td>@task.Status</td>

                @if (!isAdmin && task.AssignedToUserId == Model.CurrentUserId)
                {
                    <td>
                        <form method="post" asp-page-handler="UpdateComment" class="d-flex">
                            <input type="hidden" name="taskId" value="@task.Id" />
                            <input class="form-control" name="comment" value="@task.Comment" />
                            <button type="submit" class="btn btn-sm btn-success ml-1">üíæ</button>
                        </form>
                    </td>
                    <td>
                        <form method="post" asp-page-handler="UpdateStatus">
                            <input type="hidden" name="taskId" value="@task.Id" />
                            <select name="status" class="form-select">
                                <option selected disabled>@task.Status</option>
                                <option value="–í –ø—Ä–æ—Ü–µ—Å—Å–µ">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                                <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–æ">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary mt-1">‚úÖ</button>
                        </form>
                    </td>
                }

                @if (isAdmin)
                {
                    <td>
                        <a asp-page="Logs" asp-route-taskId="@task.Id" class="btn btn-sm btn-outline-secondary">–õ–æ–≥–∏</a>
                    </td>
                    <td>
                        <a asp-page="Edit" asp-route-id="@task.Id" class="btn btn-sm btn-outline-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    </td>
                    <td>
                        <a asp-page="Delete" asp-route-id="@task.Id" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å</a>
                    </td>
                }
            </tr>
        }
        </tbody>
    </table>
</div>
